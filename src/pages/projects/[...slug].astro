---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { slug: project.slug },
    props: { project },
  }));
};

const { project } = Astro.props;
const { Content } = await project.render();

// Get sub-pages if this is a parent project
const allProjects = await getCollection('projects');
const subPages = allProjects.filter(p => p.data.parent === project.slug);

// Get parent project if this is a sub-page
const parentProject = project.data.parent
  ? allProjects.find(p => p.slug === project.data.parent)
  : null;

// Calculate costs total if present
const costs = project.data.costs;
const total = costs ? costs.reduce((sum, item) => sum + item.cost, 0) : 0;
const formatCurrency = (n: number) => n.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });
---

<Layout title={`${project.data.title} - Ben Barnes`}>
  <nav class="breadcrumb">
    <a href="/projects">Projects</a>
    <span>/</span>
    {parentProject && (
      <>
        <a href={`/projects/${parentProject.slug}`}>{parentProject.data.title}</a>
        <span>/</span>
      </>
    )}
    <span>{project.data.title}</span>
  </nav>

  {subPages.length > 0 && (
    <section class="sub-pages">
      <ul>
        {subPages.map(page => (
          <li>
            <a href={`/projects/${page.slug}`}>{page.data.title}</a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <article class="project-content">
    <Content />

    {costs && (
      <div class="costs-table">
        <p class="costs-total"><strong>Total: {formatCurrency(total)}</strong></p>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Cost</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {costs.map(row => (
              <tr>
                <td>{row.item}</td>
                <td class="cost">{formatCurrency(row.cost)}</td>
                <td class="date">{row.date}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </article>
</Layout>

<style>
  article.project-content {
    font-size: 1.1rem;
  }

  .breadcrumb {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1rem;
    color: #666;
  }

  .breadcrumb a {
    color: #5a6a8a;
  }

  .project-content {
    line-height: 1.7;
  }

  .project-content :global(h1) {
    font-size: 1.8rem;
    font-weight: 500;
    margin: 0 0 1.5rem 0;
  }

  .project-content :global(h2) {
    font-size: 1.4rem;
    font-weight: 500;
    margin: 2rem 0 1rem 0;
  }

  .project-content :global(h3) {
    font-size: 1.2rem;
    font-weight: 500;
    margin: 1.5rem 0 0.75rem 0;
  }

  .project-content :global(p) {
    margin: 0 0 1rem 0;
  }

  .project-content :global(img) {
    max-width: 100%;
    border-radius: 8px;
    margin: 1rem 0;
  }

  .sub-pages {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
  }

  .sub-pages ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sub-pages li {
    padding: 0.25rem 0;
  }

  .sub-pages a {
    color: #5a6a8a;
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .costs-table {
    margin-top: 1rem;
  }

  .costs-total {
    font-size: 1.2rem;
    margin-bottom: 1rem;
  }

  .costs-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .costs-table th,
  .costs-table td {
    padding: 0.5rem 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  .costs-table th {
    font-weight: 500;
    background: #f5f5f5;
  }

  .costs-table .cost {
    text-align: right;
    white-space: nowrap;
  }

  .costs-table .date {
    white-space: nowrap;
    color: #666;
  }
</style>
